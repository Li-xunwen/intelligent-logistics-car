C51 COMPILER V9.60.7.0   IIC                                                               11/12/2024 00:03:35 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\IIC.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE IIC.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\IIC.l
                    -st) OBJECT(.\Objects\IIC.obj)

line level    source

   1          #include "IIC.h"
   2          
   3          bit isda;      //设备地址标志
   4          bit isma;      //储存地址标志
   5          unsigned char addr;
   6          unsigned char xdata buffer[64];
   7          sbit SDA = P1^4;
   8          sbit SCL = P1^5;
   9          void IICsetup()
  10          {
  11   1       P_SW2 |= 0x80; //使能访问 XFR
  12   1       I2CCFG = 0x81; //使能 I2C 从机模式
  13   1       I2CSLADR = 0x5A; //设置从机设备地址寄存器 I2CSLADR=0101_1010B
  14   1                        //即 I2CSLADR[7:1]=010_1101B,MA=0B。
  15   1                        //由于 MA 为 0,主机发送的的设备地址必须与
  16   1                        //I2CSLADR[7:1]相同才能访问此 I2C 从机设备。
  17   1                        //主机若需要写数据则要发送 5AH(0101_1010B)
  18   1                        //主机若需要读数据则要发送 5BH(0101_1011B)
  19   1       I2CSLST = 0x00;
  20   1       I2CSLCR = 0x78; //使能从机模式中断
  21   1       isda = 1; //用户变量初始化
  22   1       isma = 1;
  23   1       addr = 0;
  24   1       I2CTXD = buffer[addr];
  25   1       P1M0 = 0x30; P1M1 = 0x30; 
  26   1      }
  27          
  28          void I2C_Isr() interrupt 24 
  29          {
  30   1       if (I2CSLST & 0x40)
  31   1       {
  32   2        I2CSLST &= ~0x40; //处理 START 事件
  33   2        isda = 1; //若为重复起始信号时必须作此设置
  34   2       }
  35   1       else if (I2CSLST & 0x20)
  36   1       {
  37   2         I2CSLST &= ~0x20; //处理 RECV 事件
  38   2         if (isda)
  39   2         { 
  40   3          isda = 0; //处理 RECV 事件（RECV DEVICE ADDR）
  41   3         }
  42   2         else if (isma)
  43   2         {
  44   3          isma = 0; //处理 RECV 事件（RECV MEMORY ADDR）
  45   3          addr = I2CRXD;
  46   3          I2CTXD = buffer[addr];
  47   3         }
  48   2         else
  49   2         {
  50   3          buffer[addr++] = I2CRXD; //处理 RECV 事件（RECV DATA）
  51   3         }
  52   2       }
  53   1        else if (I2CSLST & 0x10)
  54   1       {
C51 COMPILER V9.60.7.0   IIC                                                               11/12/2024 00:03:35 PAGE 2   

  55   2         I2CSLST &= ~0x10; //处理 SEND 事件
  56   2         if (I2CSLST & 0x02)
  57   2         { 
  58   3          I2CTXD = 0xff; //接收到 NAK 则停止读取数据
  59   3         }
  60   2         else
  61   2         {
  62   3          I2CTXD = buffer[++addr]; //接收到 ACK 则继续读取数据
  63   3         }
  64   2       }
  65   1       else if (I2CSLST & 0x08)
  66   1       {
  67   2        I2CSLST &= ~0x08; //处理 STOP 事件
  68   2        isda = 1;
  69   2        isma = 1;
  70   2       }
  71   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    213    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     64    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
